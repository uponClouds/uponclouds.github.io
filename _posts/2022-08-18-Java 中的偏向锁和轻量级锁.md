---
layout: post
title: Java 中的偏向锁和轻量级锁
categories: Java
---

在为了减少获得锁和释放锁带来的性能消耗，在 Java SE 1.6 中开始引入了 “偏向锁” 和 “轻量级锁” ，此时锁一共有四种状态，从低到高分别是：**无锁状态、偏向锁状态、轻量级锁状态和重量级锁状态**，这几个状态会随着竞争情况逐渐升级。锁可以升级但不能降级，意味着偏向锁升级成轻量级锁后不能降级成偏向锁。

## 锁状态

当某个线程要访问某个对象时，是如何判断该对象是否有锁的呢？这就需要检查对象的对象头了。 HotSpot 虚拟机的对象头（Object Header）分为两部分，第一部分用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄（Generational GC Age）等。这部分数据的长度在32位和64位的 Java 虚拟机中分别会占用32个或64个比特，官方称它为 `Mark Word`。这部分是实现轻量级锁和偏向锁的关键。另外一部分用于存储指向方法区对象类型数据的指针，如果是数组对象，还会有一个额外的部分用于存储数组长度。

在无锁状态时，JVM(32位)的 `Mark Word` 默认储存结构如下图所示：![](https://blogimg-1253107768.cos.ap-guangzhou.myqcloud.com/blogImage/20220815191128.png)

在运行期间，`Mark Word` 里的数据会随着锁标志位的变化而变化：![](https://blogimg-1253107768.cos.ap-guangzhou.myqcloud.com/blogImage/20220815191327.png)

## 偏向锁

引入偏向锁的目的是消除数据在无竞争情况下的同步原语，进一步提高程序的运行性能。因为在大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得。

